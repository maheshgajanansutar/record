<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡§¨‡§ø‡§®‡§∂‡•á‡§§‡•Ä ‡§ú‡§Æ‡•Ä‡§® ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‚Äî PDF popup (fetch‚Üíblob)</title>
  <style>
    :root{
      --primary:#4361ee;--primary-dark:#3a56d4;--success:#4ade80;--warning:#f59e0b;
      --light:#f8fafc;--dark:#0f172a;--gray:#64748b;--radius:12px;--shadow:0 10px 30px rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:linear-gradient(135deg,#f0f4f8,#d9e2ec);color:#0f172a}
    .container{max-width:1200px;margin:28px auto;padding:20px}
    header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:26px;border-radius:var(--radius);box-shadow:var(--shadow)}
    h1{font-size:1.9rem;text-align:center;margin-bottom:6px}
    .subtitle{text-align:center;opacity:.92;font-size:0.95rem;margin-bottom:10px}

    .stats{display:flex;gap:12px;justify-content:center;margin-top:14px;flex-wrap:wrap}
    .stat-box{background:rgba(255,255,255,0.13);padding:12px 18px;border-radius:10px;text-align:center;min-width:110px}
    .stat-number{font-weight:700;font-size:1.25rem}
    .stat-label{font-size:0.85rem;opacity:.95}

    .search-section{background:#fff;padding:18px;border-radius:12px;margin-top:20px;box-shadow:var(--shadow)}
    .section-title{font-size:1.1rem;margin-bottom:12px;font-weight:600}
    .search-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    label{display:block;margin-bottom:6px;font-weight:600;font-size:.95rem}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6eef8;background:#fbfdff;font-size:0.95rem}
    .button-group{grid-column:1/-1;display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}
    button{padding:10px 16px;border-radius:999px;border:none;cursor:pointer;font-weight:600}
    .primary{background:var(--primary);color:#fff}
    .reset{background:linear-gradient(135deg,#f72585,#e11d8b);color:#fff}
    .download{background:linear-gradient(135deg,var(--success),#22c55e);color:#fff}
    .print{background:linear-gradient(135deg,var(--warning),#d97706);color:#fff}

    .results-section{margin-top:18px;background:#fff;border-radius:12px;box-shadow:var(--shadow);display:none;overflow:hidden}
    .results-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0b1220;color:#fff}
    .table-container{overflow:auto;max-height:480px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #eef2f7;text-align:left;font-size:0.95rem}
    th{background:#f6f9fc;font-weight:700;position:sticky;top:0}
    tr:hover td{background:#fbfdff}
    .download-link{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(67,97,238,0.06);text-decoration:none;color:var(--primary);font-weight:600}

    .no-results{padding:36px;text-align:center;color:var(--gray);display:none}

    /* PDF popup */
    .pdf-popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:9999;align-items:center;justify-content:center}
    .pdf-box{background:#fff;width:94%;height:90%;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
    .pdf-head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #eef2f7}
    .pdf-title{font-weight:700}
    .pdf-actions{display:flex;gap:8px;align-items:center}
    .pdf-iframe{flex:1;border:0;width:100%;background:#fff}
    .pdf-message{padding:10px 14px;border-top:1px solid #eef2f7;font-size:0.95rem;color:#334155;background:#f8fafc;display:none}

    .spinner{width:36px;height:36px;border-radius:50%;border:4px solid rgba(0,0,0,0.08);border-top-color:var(--primary);animation:spin 1s linear infinite;margin-right:8px}
    @keyframes spin { to { transform: rotate(360deg); } }

    /* messages */
    .message{padding:12px;border-radius:8px;margin:12px 0;display:none}
    .error{background:rgba(239,68,68,0.08);border-left:4px solid #ef4444;color:#7f1d1d}
    .success{background:rgba(34,197,94,0.08);border-left:4px solid #22c55e;color:#14532d}

    /* responsive */
    @media (max-width:600px){
      h1{font-size:1.4rem}
      .search-form{grid-template-columns:1fr}
      .pdf-box{width:98%;height:92%}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>‡§¨‡§ø‡§®‡§∂‡•á‡§§‡•Ä ‡§ú‡§Æ‡•Ä‡§® ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§∂‡•ã‡§ß</h1>
      <div class="subtitle">PDF popup ‚Äî fetch ‚Üí blob ‡§µ‡§æ‡§™‡§∞‡•Ç‡§® preview</div>

      <div class="stats" aria-hidden="true">
        <div class="stat-box"><div class="stat-number" id="totalRecords">0</div><div class="stat-label">‡§è‡§ï‡•Ç‡§£ ‡§®‡•ã‡§Ç‡§¶‡•Ä</div></div>
        <div class="stat-box"><div class="stat-number" id="totalTalukas">0</div><div class="stat-label">‡§§‡§æ‡§≤‡•Å‡§ï‡•á</div></div>
        <div class="stat-box"><div class="stat-number" id="totalVillages">0</div><div class="stat-label">‡§ó‡§æ‡§µ‡•á</div></div>
        <div class="stat-box"><div class="stat-number" id="startYear">-</div><div class="stat-label">‡§∏‡•Å‡§∞‡§µ‡§æ‡§§‡•Ä‡§ö‡•á ‡§µ‡§∞‡•ç‡§∑</div></div>
      </div>
    </header>

    <div id="errorMessage" class="message error" role="alert"></div>
    <div id="successMessage" class="message success" role="status"></div>

    <section class="search-section" aria-labelledby="searchHeading">
      <h2 id="searchHeading" class="section-title">‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§∂‡•ã‡§ß‡§æ</h2>

      <form id="searchForm" class="search-form" onsubmit="return false;">
        <div>
          <label for="taluka">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ</label>
          <select id="taluka"><option value="">‡§∏‡§∞‡•ç‡§µ ‡§§‡§æ‡§≤‡•Å‡§ï‡•á</option></select>
        </div>

        <div>
          <label for="village">‡§ó‡§æ‡§µ</label>
          <select id="village"><option value="">‡§∏‡§∞‡•ç‡§µ ‡§ó‡§æ‡§µ‡•á</option></select>
        </div>

        <div>
          <label for="holderName">‡§ß‡§æ‡§∞‡§ï‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</label>
          <input id="holderName" placeholder="‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ" />
        </div>

        <div>
          <label for="surveyNo">‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡•á ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï</label>
          <input id="surveyNo" placeholder="‡§â‡§¶‡§æ. 45/2" />
        </div>

        <div>
          <label for="year">‡§µ‡§∞‡•ç‡§∑</label>
          <select id="year"><option value="">‡§∏‡§∞‡•ç‡§µ ‡§µ‡§∞‡•ç‡§∑</option></select>
        </div>

        <div>
          <label for="type">‡§¨‡§ø‡§®‡§∂‡•á‡§§‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
          <select id="type">
            <option value="">‡§∏‡§∞‡•ç‡§µ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</option>
            <option value="‡§®‡§ø‡§µ‡§æ‡§∏‡•Ä">‡§®‡§ø‡§µ‡§æ‡§∏‡•Ä</option>
            <option value="‡§µ‡§æ‡§£‡§ø‡§ú‡•ç‡§Ø">‡§µ‡§æ‡§£‡§ø‡§ú‡•ç‡§Ø</option>
            <option value="‡§î‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§ï">‡§î‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§ï</option>
          </select>
        </div>

        <div class="button-group">
          <button class="primary" id="searchBtn" type="button">üîé ‡§∂‡•ã‡§ß‡§æ</button>
          <button class="reset" id="resetBtn" type="button">‚Ü∫ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§æ</button>
          <button class="download" id="downloadBtn" type="button">‚¨á CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
          <button class="print" id="printBtn" type="button">üñ® ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</button>
        </div>
      </form>
    </section>

    <section id="resultsSection" class="results-section" aria-live="polite">
      <div class="results-header">
        <div><strong>‡§∂‡•ã‡§ß ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ</strong></div>
        <div id="resultsCount">0 ‡§®‡•ã‡§Ç‡§¶‡•Ä</div>
      </div>

      <div class="table-container">
        <table id="resultsTable" aria-describedby="resultsCount">
          <thead>
            <tr>
              <th>‡§Ö.‡§ï‡•ç‡§∞.</th><th>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ</th><th>‡§ó‡§æ‡§µ</th><th>‡§ß‡§æ‡§∞‡§ï</th><th>‡§µ‡§∞‡•ç‡§∑</th><th>‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡•á</th><th>‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</th><th>‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>

      <div id="noResults" class="no-results">‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§∂‡•ã‡§ß‡§æ‡§∂‡•Ä ‡§ú‡•Å‡§≥‡§£‡§æ‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶ ‡§∏‡§æ‡§™‡§°‡§≤‡•Ä ‡§®‡§æ‡§π‡•Ä.</div>
      <div id="pagination" style="display:flex;gap:8px;justify-content:center;padding:12px"></div>
    </section>

    <!-- PDF popup: tries blob preview; fallback = open in new tab -->
    <div id="pdfPopup" class="pdf-popup" role="dialog" aria-hidden="true">
      <div class="pdf-box" role="document">
        <div class="pdf-head">
          <div style="display:flex;align-items:center;gap:12px">
            <div id="pdfSpinner" class="spinner" style="display:none"></div>
            <div class="pdf-title" id="pdfPopupTitle">PDF</div>
          </div>
          <div class="pdf-actions">
            <a id="openInNewTab" href="#" target="_blank" rel="noopener noreferrer" style="display:none;padding:8px 10px;border-radius:8px;background:#0ea5e9;color:#fff;text-decoration:none;font-weight:600">Open in new tab</a>
            <button id="pdfClose" style="padding:8px 10px;border-radius:8px;border:none;cursor:pointer;background:#ef4444;color:#fff">‚úï ‡§¨‡§Ç‡§¶</button>
          </div>
        </div>

        <iframe id="pdfIframe" class="pdf-iframe" title="PDF viewer"></iframe>
        <div id="pdfMessage" class="pdf-message">PDF preview blocked ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§≤‡•ã‡§° ‡§ù‡§æ‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä? ‚Äî "Open in new tab" ‡§µ‡§æ‡§™‡§∞‡§æ.</div>
      </div>
    </div>

    <footer style="margin-top:18px;text-align:center;opacity:.8;font-size:.9rem">
      ¬© Offline Land Records ‚Äî Single file
    </footer>
  </div>

  <!-- Inline sample data (editable) -->
  <script id="inline-data" type="application/json">
  {
    "landRecords": [
      {"taluka":"‡§ï‡§£‡§ï‡§µ‡§≤‡•Ä","village":"‡§ï‡§£‡§ï‡§µ‡§≤‡•Ä","holderName":"‡§∞‡§æ‡§ú‡•Ç ‡§∂‡§ø‡§Ç‡§¶‡•á","year":2018,"surveyNo":"45/2","type":"‡§®‡§ø‡§µ‡§æ‡§∏‡•Ä","downloadLink":"http://sdokankavli.com/wp-content/uploads/2025/10/SR3601989-1.pdf"},
      {"taluka":"‡§∏‡§æ‡§µ‡§Ç‡§§‡§µ‡§æ‡§°‡•Ä","village":"‡§∏‡§æ‡§µ‡§Ç‡§§‡§µ‡§æ‡§°‡•Ä ‡§ó‡§æ‡§µ","holderName":"‡§∏‡§æ‡§µ‡§ø‡§§‡•ç‡§∞‡•Ä ‡§ú‡•ã‡§∂‡•Ä","year":2020,"surveyNo":"102","type":"‡§µ‡§æ‡§£‡§ø‡§ú‡•ç‡§Ø","downloadLink":"data/pdfs/SR1276(1989).pdf"},
      {"taluka":"‡§ï‡§£‡§ï‡§µ‡§≤‡•Ä","village":"‡§™‡•ã‡§†","holderName":"‡§µ‡§ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡§¶‡§Æ","year":2016,"surveyNo":"12A","type":"‡§î‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§ï","downloadLink":""}
    ]
  }
  </script>

  <script>
  (function(){
    let landRecords = [];
    const recordsPerPage = 10;
    let currentPage = 1;
    let lastFiltered = [];
    let currentPdfBlobUrl = null; // hold blob URL to revoke later

    // elements
    const talukaEl = document.getElementById('taluka');
    const villageEl = document.getElementById('village');
    const yearEl = document.getElementById('year');
    const typeEl = document.getElementById('type');
    const holderEl = document.getElementById('holderName');
    const surveyEl = document.getElementById('surveyNo');

    const resultsSection = document.getElementById('resultsSection');
    const resultsBody = document.getElementById('resultsBody');
    const resultsCount = document.getElementById('resultsCount');
    const noResults = document.getElementById('noResults');
    const paginationEl = document.getElementById('pagination');

    const totalRecordsEl = document.getElementById('totalRecords');
    const totalTalukasEl = document.getElementById('totalTalukas');
    const totalVillagesEl = document.getElementById('totalVillages');
    const startYearEl = document.getElementById('startYear');

    const errorMessageEl = document.getElementById('errorMessage');
    const successMessageEl = document.getElementById('successMessage');

    // pdf popup elements
    const pdfPopup = document.getElementById('pdfPopup');
    const pdfIframe = document.getElementById('pdfIframe');
    const pdfPopupTitle = document.getElementById('pdfPopupTitle');
    const pdfClose = document.getElementById('pdfClose');
    const openInNewTab = document.getElementById('openInNewTab');
    const pdfSpinner = document.getElementById('pdfSpinner');
    const pdfMessage = document.getElementById('pdfMessage');

    function init(){
      loadInlineOrDataJson();
      attachEventListeners();
    }

    function showError(msg){
      errorMessageEl.textContent = msg;
      errorMessageEl.style.display = 'block';
      setTimeout(()=>errorMessageEl.style.display='none',5000);
    }
    function showSuccess(msg){
      successMessageEl.textContent = msg;
      successMessageEl.style.display = 'block';
      setTimeout(()=>successMessageEl.style.display='none',3000);
    }

    function loadInlineOrDataJson(){
      try{
        const inlineEl = document.getElementById('inline-data');
        if(inlineEl){
          const data = JSON.parse(inlineEl.textContent || inlineEl.innerText);
          if(data && Array.isArray(data.landRecords)){
            landRecords = data.landRecords;
            afterLoad();
            return;
          }
        }
      }catch(e){
        console.warn('Inline data parse failed', e);
      }

      fetch('data.json').then(r=>{
        if(!r.ok) throw new Error('data.json ‡§∏‡§æ‡§™‡§°‡§≤‡•á ‡§®‡§æ‡§π‡•Ä');
        return r.json();
      }).then(d=>{
        landRecords = d.landRecords || [];
        afterLoad();
      }).catch(err=>{
        console.warn('data.json unavailable or failed to load:', err);
        afterLoad();
      });
    }

    function afterLoad(){
      populateDropdowns();
      updateStatistics();
    }

    function populateDropdowns(){
      const talukas = [...new Set(landRecords.map(r=>r.taluka).filter(Boolean))].sort();
      const villages = [...new Set(landRecords.map(r=>r.village).filter(Boolean))].sort();
      const years = [...new Set(landRecords.map(r=>r.year).filter(Boolean))].sort((a,b)=>b-a);

      while(talukaEl.options.length>1) talukaEl.remove(1);
      talukas.forEach(t=> { const o=document.createElement('option'); o.value=t; o.textContent=t; talukaEl.appendChild(o); });

      while(villageEl.options.length>1) villageEl.remove(1);
      villages.forEach(v=> { const o=document.createElement('option'); o.value=v; o.textContent=v; villageEl.appendChild(o); });

      while(yearEl.options.length>1) yearEl.remove(1);
      years.forEach(y=> { const o=document.createElement('option'); o.value=y; o.textContent=y; yearEl.appendChild(o); });
    }

    function updateStatistics(){
      totalRecordsEl.textContent = landRecords.length;
      const talukasCount = new Set(landRecords.map(r=>r.taluka)).size;
      const villagesCount = new Set(landRecords.map(r=>r.village)).size;
      const years = landRecords.map(r=>Number(r.year)).filter(Boolean);
      const start = years.length?Math.min(...years):'-';
      totalTalukasEl.textContent = talukasCount;
      totalVillagesEl.textContent = villagesCount;
      startYearEl.textContent = start;
    }

    function attachEventListeners(){
      document.getElementById('searchBtn').addEventListener('click',performSearch);
      document.getElementById('resetBtn').addEventListener('click',()=>{
        document.getElementById('searchForm').reset();
        resultsSection.style.display='none';
      });
      document.getElementById('downloadBtn').addEventListener('click',downloadResults);
      document.getElementById('printBtn').addEventListener('click',printResults);
      talukaEl.addEventListener('change',updateVillagesFromTaluka);
      pdfClose.addEventListener('click',closePdf);
      pdfPopup.addEventListener('click',(e)=>{ if(e.target===pdfPopup) closePdf(); });

      holderEl.addEventListener('input',()=>{ holderEl.value = holderEl.value.replace(/[^a-zA-Z\u0900-\u097F0-9\s.-]/g,''); });
      surveyEl.addEventListener('input',()=>{ surveyEl.value = surveyEl.value.replace(/[^a-zA-Z0-9\u0900-\u097F\/\\-\\.\\s]/g,''); });

      // iframe load handling: hide spinner when load completes
      pdfIframe.addEventListener('load', function(){
        // hide spinner & show fallback link so user can still open externally if needed
        pdfSpinner.style.display = 'none';
        pdfMessage.style.display = 'block';
        openInNewTab.style.display = 'inline-block';
      });
    }

    function updateVillagesFromTaluka(){
      const selected = talukaEl.value;
      while(villageEl.options.length>1) villageEl.remove(1);
      let villages = [];
      if(selected){
        villages = [...new Set(landRecords.filter(r=>r.taluka===selected).map(r=>r.village).filter(Boolean))].sort();
      } else {
        villages = [...new Set(landRecords.map(r=>r.village).filter(Boolean))].sort();
      }
      villages.forEach(v=> { const o=document.createElement('option'); o.value=v; o.textContent=v; villageEl.appendChild(o); });
    }

    function performSearch(){
      try{
        const taluka = talukaEl.value;
        const village = villageEl.value;
        const holder = holderEl.value.trim().toLowerCase();
        const survey = surveyEl.value.trim().toLowerCase();
        const year = yearEl.value;
        const type = typeEl.value;

        const filtered = landRecords.filter(r=>{
          return (!taluka || r.taluka===taluka) &&
                 (!village || r.village===village) &&
                 (!holder || (r.holderName && r.holderName.toLowerCase().includes(holder))) &&
                 (!survey || (r.surveyNo && r.surveyNo.toLowerCase().includes(survey))) &&
                 (!year || String(r.year)===String(year)) &&
                 (!type || r.type===type);
        });

        lastFiltered = filtered;
        currentPage = 1;
        renderResultsPage(filtered,1);
        resultsSection.style.display = 'block';
        if(filtered.length) showSuccess(filtered.length+' ‡§®‡•ã‡§Ç‡§¶‡•Ä ‡§∏‡§æ‡§™‡§°‡§≤‡•ç‡§Ø‡§æ'); else showError('‡§ï‡§æ‡§π‡•Ä‡§π‡•Ä ‡§∏‡§æ‡§™‡§°‡§≤‡•á ‡§®‡§æ‡§π‡•Ä.');
      }catch(e){
        console.error(e);
        showError('‡§∂‡•ã‡§ß ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡•á‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä ‚Äî ‡§ï‡§®‡•ç‡§∏‡•ã‡§≤ ‡§§‡§™‡§æ‡§∏‡§æ.');
      }
    }

    function renderResultsPage(records,page){
      resultsBody.innerHTML='';
      if(!records || records.length===0){
        noResults.style.display='block';
        paginationEl.style.display='none';
        resultsCount.textContent = '0 ‡§®‡•ã‡§Ç‡§¶‡•Ä';
        return;
      }
      noResults.style.display='none';
      const totalPages = Math.ceil(records.length/recordsPerPage);
      page = Math.min(Math.max(1,page), totalPages);
      currentPage = page;

      const start = (page-1)*recordsPerPage;
      const end = Math.min(start+recordsPerPage, records.length);
      for(let i=start;i<end;i++){
        const r = records[i];
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>'+(i+1)+'</td>'+
                       '<td>'+(r.taluka||'')+'</td>'+
                       '<td>'+(r.village||'')+'</td>'+
                       '<td>'+(r.holderName||'')+'</td>'+
                       '<td>'+(r.year||'')+'</td>'+
                       '<td>'+(r.surveyNo||'')+'</td>'+
                       '<td>'+(r.type||'')+'</td>'+
                       '<td><a class="download-link" href="'+(r.downloadLink||'#')+'" data-pdf="'+(r.downloadLink||'')+'" data-name="'+(r.holderName||'')+' - '+(r.surveyNo||'')+'" target="_blank" rel="noopener noreferrer">‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</a></td>';
        resultsBody.appendChild(tr);
      }

      resultsCount.textContent = records.length + ' ‡§®‡•ã‡§Ç‡§¶‡•Ä';
      renderPagination(totalPages);

      // clicking download ALWAYS tries popup preview first
      document.querySelectorAll('.download-link').forEach(a=>{
        a.addEventListener('click',function(e){
          const link = (this.getAttribute('data-pdf') || '').trim();
          const name = this.getAttribute('data-name') || 'PDF';
          if(!link){
            e.preventDefault();
            showError('‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§≤‡§ø‡§Ç‡§ï ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä');
            return;
          }
          e.preventDefault();
          openPdfInPopup(link, name);
        }, {passive:false});
      });
    }

    function renderPagination(totalPages){
      paginationEl.innerHTML='';
      if(totalPages<=1){ paginationEl.style.display='none'; return; }
      paginationEl.style.display='flex';

      const makeBtn = (txt,disabled,cb)=>{
        const b = document.createElement('button'); b.textContent = txt;
        b.disabled = !!disabled; b.style.padding='8px 10px'; b.style.borderRadius='8px';
        b.style.border='1px solid #e6eef8'; b.style.background='#fff'; b.style.cursor='pointer';
        b.addEventListener('click',cb);
        return b;
      };

      paginationEl.appendChild(makeBtn('¬´', currentPage===1, ()=>{ if(currentPage>1){ currentPage--; renderResultsPage(lastFiltered,currentPage); } }));
      for(let p=1;p<=totalPages;p++){
        const btn = document.createElement('button'); btn.textContent = p; btn.style.padding='8px 10px'; btn.style.borderRadius='8px';
        btn.style.border = p===currentPage ? '1px solid var(--primary)' : '1px solid #e6eef8';
        btn.style.background = p===currentPage ? 'var(--primary)' : '#fff';
        btn.style.color = p===currentPage ? '#fff' : '#000';
        btn.addEventListener('click',()=>{ currentPage = p; renderResultsPage(lastFiltered,p); });
        paginationEl.appendChild(btn);
      }
      paginationEl.appendChild(makeBtn('¬ª', currentPage===totalPages, ()=>{ if(currentPage<totalPages){ currentPage++; renderResultsPage(lastFiltered,currentPage); } }));
    }

    // ---------- NEW: fetch -> blob preview with fallback ----------
    function openPdfInPopup(url, name){
      pdfPopupTitle.textContent = name || 'PDF';
      pdfSpinner.style.display = 'inline-block';
      pdfMessage.style.display = 'none';
      openInNewTab.style.display = 'none';
      openInNewTab.setAttribute('href', url);

      // Clear previous iframe & revoke old blob
      if(pdfIframe.src) pdfIframe.src = '';
      if(currentPdfBlobUrl){ URL.revokeObjectURL(currentPdfBlobUrl); currentPdfBlobUrl = null; }

      pdfPopup.style.display = 'flex';
      pdfPopup.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';

      // Try fetch -> blob
      // Note: this succeeds only if server permits CORS or is same-origin. If it fails, fallback will show.
      fetch(url).then(response=>{
        if(!response.ok) throw new Error('PDF fetch failed: ' + response.status);
        return response.blob();
      }).then(blob=>{
        // Create blob URL and assign to iframe
        currentPdfBlobUrl = URL.createObjectURL(blob);
        pdfIframe.src = currentPdfBlobUrl;

        // Provide fallback link to original URL too
        openInNewTab.href = url;
        openInNewTab.style.display = 'inline-block';
      }).catch(err=>{
        console.warn('fetch->blob failed:', err);
        // fallback: show message + open in new tab link
        pdfSpinner.style.display = 'none';
        pdfMessage.style.display = 'block';
        openInNewTab.href = url;
        openInNewTab.style.display = 'inline-block';
        showError('PDF preview ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§ ‡§®‡§æ‡§π‡•Ä ‚Äî "Open in new tab" ‡§µ‡§æ‡§™‡§∞‡§æ.');
      });

      // Timeout fallback: if iframe didn't load in reasonable time, show fallback UI
      const fallbackTimeout = setTimeout(()=>{
        pdfSpinner.style.display = 'none';
        pdfMessage.style.display = 'block';
        openInNewTab.style.display = 'inline-block';
      }, 3500);

      // One-time load handler
      const onLoadOnce = function(){
        clearTimeout(fallbackTimeout);
        pdfSpinner.style.display = 'none';
        pdfMessage.style.display = 'block';
        openInNewTab.style.display = 'inline-block';
        pdfIframe.removeEventListener('load', onLoadOnce);
      };
      pdfIframe.addEventListener('load', onLoadOnce);
    }

    function closePdf(){
      // revoke blob url to free memory
      if(currentPdfBlobUrl){ URL.revokeObjectURL(currentPdfBlobUrl); currentPdfBlobUrl = null; }
      pdfIframe.src = '';
      pdfPopup.style.display = 'none';
      pdfPopup.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      pdfSpinner.style.display = 'none';
      pdfMessage.style.display = 'none';
      openInNewTab.style.display = 'none';
    }
    // ---------- end fetch->blob code ----------

    function downloadResults(){
      const taluka = talukaEl.value;
      const village = villageEl.value;
      const holder = holderEl.value.trim().toLowerCase();
      const survey = surveyEl.value.trim().toLowerCase();
      const year = yearEl.value;
      const type = typeEl.value;

      const filtered = landRecords.filter(r=>{
        return (!taluka || r.taluka===taluka) &&
               (!village || r.village===village) &&
               (!holder || (r.holderName && r.holderName.toLowerCase().includes(holder))) &&
               (!survey || (r.surveyNo && r.surveyNo.toLowerCase().includes(survey))) &&
               (!year || String(r.year)===String(year)) &&
               (!type || r.type===type);
      });

      if(!filtered.length){ showError('‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡•á‡§π‡•Ä ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§æ‡§π‡•Ä‡§§'); return; }

      let csv = '‡§Ö.‡§ï‡•ç‡§∞.,‡§§‡§æ‡§≤‡•Å‡§ï‡§æ,‡§ó‡§æ‡§µ,‡§ß‡§æ‡§∞‡§ï,‡§µ‡§∞‡•ç‡§∑,‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡•á,‡§™‡•ç‡§∞‡§ï‡§æ‡§∞,‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§≤‡§ø‡§Ç‡§ï\n';
      filtered.forEach((r,i)=>{
        const esc = v => ('"' + String(v||'').replace(/"/g,'""') + '"');
        csv += [i+1, r.taluka, r.village, r.holderName, r.year, r.surveyNo, r.type, r.downloadLink].map(esc).join(',') + '\n';
      });

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'land_records.csv'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      showSuccess('CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§™‡•Ç‡§∞‡•ç‡§£');
    }

    function printResults(){
      if(resultsSection.style.display==='block' || resultsBody.children.length>0){
        window.print();
      } else {
        showError('‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§™‡•ç‡§∞‡§•‡§Æ ‡§∂‡•ã‡§ß ‡§ï‡§∞‡§æ');
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
